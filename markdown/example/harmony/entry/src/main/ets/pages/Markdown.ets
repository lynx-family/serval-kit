import {
  ServalMarkdownView,
  ServalMarkdownStyle,
  ServalMarkdownStyleSheet,
  ServalMarkdownConfig,
} from "@lynx/serval_markdown";
import { createNode } from "./Button";

interface MarkdownStyleExtended extends ServalMarkdownStyleSheet {
  ".red"?: ServalMarkdownStyle,
  ".bold"?: ServalMarkdownStyle,
  ".big"?: ServalMarkdownStyle,
  ".small"?: ServalMarkdownStyle,
  ".underline"?: ServalMarkdownStyle,
  unorderedListMarker ?: ServalMarkdownStyle,
}

@Component
export struct Markdown {
  private servalMarkdownView = new ServalMarkdownView()
  private servalMarkdownStyle: MarkdownStyleExtended = {
    h1:{
      marginTop: 50,
    },
    quote: {
      color: "808080"
    },
    link: {
      color: "0000ff"
    },
    ".red": {
      color: "ff0000"
    },
    ".bold": {
      fontWeight: "bold"
    },
    ".big": {
      fontSize: 25
    },
    ".small": {
      fontSize: 12
    },
    unorderedListMarker: {
      color: "000000"
    }
  }
  private servalMarkdownConfig: ServalMarkdownConfig = {
    animationType: "none",
    animationVelocity: 20,
    enableSelection: true,
    sourceType: "markdown",
    selectionHandleColor: "79bbff",
    selectionHighlightColor: "6679bbff"
  }
  private content: string = `
# ä»¥ä¸‹æ˜¯æ™®é€šæ–‡æœ¬ï¼š

![](inlineview://aaa)

è¿™æ˜¯ä¸€æ®µæ™®é€šæ–‡æœ¬ï¼Œ***111****1*åŒ…å«**ç²—ä½“**ã€*æ–œä½“*ã€***ç²—ä½“+ testtetstest æ–œä½“***ã€***æ–œä½“*ç²—ä½“æ··åˆ**ã€~~åˆ é™¤çº¿~~ã€\`inline code\`ï¼Œ<span class="mark">è¿™äº›<span class="red">çº¢è‰²<span class="bold">åŠ ç²—<span class="underline">ä¸‹åˆ’çº¿</span><span class="big">å¤§å­—å·<span class="small">*å°æ–œä½“*</span></span></span></span>æ··åˆçš„è¡Œå†…çš„æ ·å¼</span>ï¼Œä»¥åŠè¡¨æƒ…ï¼šğŸ˜„

### ä»¥ä¸‹æ˜¯å¼•ç”¨å—ï¼š

> è¯»ä¸€æœ¬å¥½ä¹¦ï¼Œå°±æ˜¯åœ¨å’Œé«˜å°šçš„äººè°ˆè¯ã€‚ [æ­Œå¾·](url://link)
> \`\`\`
> code block in quote code block in quote code block in quote code block in quote code block in quote
> \`\`\`
> é›‡ç”¨åˆ¶åº¦å¯¹å·¥äººä¸åˆ©ï¼Œä½†å·¥äººæ ¹æœ¬æ— åŠ›æ‘†è„±è¿™ä¸ªåˆ¶åº¦ã€‚é˜®ä¸€å³°

![](inlineview://aaa)

-----

### ä»¥ä¸‹æ˜¯åˆ—è¡¨ï¼š

1. æœ‰åºåˆ—è¡¨1
    1. åµŒå¥—æœ‰åºåˆ—è¡¨1
    2. åµŒå¥—æœ‰åºåˆ—è¡¨2
    3. åµŒå¥—æœ‰åºåˆ—è¡¨3
2. æœ‰åºåˆ—è¡¨2
3. æœ‰åºåˆ—è¡¨3

- æ— åºåˆ—è¡¨1
  - æ— åºåˆ—è¡¨2
  - æ— åºåˆ—è¡¨3
- æ— åºåˆ—è¡¨4

### ä»¥ä¸‹æ˜¯è¡¨æ ¼ï¼š

| ç¼–ç¨‹è¯­è¨€ | åˆ›å§‹äºº       | å‘å¸ƒå¹´ä»½ | ä¸»è¦åº”ç”¨é¢†åŸŸ       |
| :------- | :----------- | :------- | :----------------- |
| Python   | Guido van Rossum | 1991    | æ•°æ®åˆ†æã€AIå¼€å‘   |
| Java     | James Gosling   | 1995    | ä¼ä¸šçº§å¼€å‘ã€Android |
| JavaScript | Brendan Eich   | 1995    | å‰ç«¯å¼€å‘ã€å…¨æ ˆå¼€å‘ |
| Go       | Robert Griesemer ç­‰ | 2009   | äº‘è®¡ç®—ã€åç«¯æœåŠ¡   |

`
  private contentLength = 1

  build() {
    Row() {
      ContentSlot(this.servalMarkdownView)
    }
  }

  appendContent() {
    if (this.contentLength >= this.content.length) {
      return
    }
    this.contentLength += 2000;
    this.servalMarkdownView.setContent(this.content.substring(0, this.contentLength))
    // setTimeout(() => {
    //   this.appendContent()
    // }, 100)
  }

  onDidBuild(): void {
    this.servalMarkdownView.setContent(this.content.substring(0, this.contentLength))
    this.servalMarkdownView.setStyle(this.servalMarkdownStyle)
    this.servalMarkdownView.setConfig(this.servalMarkdownConfig)
    let inlineViewLoader = (id: string) => {
      let builder = createNode(this.getUIContext())
      return builder.getFrameNode()
    }
    let replacementViewLoader = (ud: number) => {
      let builder = createNode(this.getUIContext())
      return builder.getFrameNode()
    }
    this.servalMarkdownView.registerInlineViewLoader(inlineViewLoader)
    this.servalMarkdownView.registerReplacementViewLoader(replacementViewLoader)
    this.bindEvents()
    this.bindExposure()
    this.appendContent()
  }

  bindEvents(): void {
    this.servalMarkdownView.bindEvent("parseEnd", () => {
      console.log("serval_markdown: parseEnd")
    })
    this.servalMarkdownView.bindEvent("drawStart", () => {
      console.log("serval_markdown: drawStart")
    })
    this.servalMarkdownView.bindEvent("drawEnd", () => {
      console.log("serval_markdown: drawEnd")
    })
    this.servalMarkdownView.bindEvent("animationStep", (current: number, max: number) => {
      console.log("serval_markdown: animationStep:" + current + " max:" + max)
    })
    this.servalMarkdownView.bindEvent("linkClicked", (url: string, content: string) => {
      console.log("serval_markdown: link: " + url + " content:" + content + " clicked")
    });
    this.servalMarkdownView.bindEvent("imageClicked", (url: string) => {
      console.log("serval_markdown: image: " + url + " clicked")
    })
    this.servalMarkdownView.bindEvent("selectionChanged", (start: number, end: number, direction: string, state:string) => {
      console.log("serval_markdown: selectionChanged: " + start + "," + end + " direction:" + direction + " state:" + state)
    })
  }

  bindExposure(): void {
    this.servalMarkdownView.bindExposure("imageAppear", (url: string) => {
      console.log("serval_markdown: image: " + url + " appear")
    })
    this.servalMarkdownView.bindExposure("imageDisappear", (url: string) => {
      console.log("serval_markdown: image: " + url + " disappear")
    })
    this.servalMarkdownView.bindExposure("linkAppear", (url: string, content: string) => {
      console.log("serval_markdown: link: " + url + ":" + content + " appear")
    })
    this.servalMarkdownView.bindExposure("linkDisappear", (url: string, content: string) => {
      console.log("serval_markdown: link: " + url + ":" + content + " disappear")
    })
  }
}
