name: Build SVG Artifacts

on:
  push:
    branches: ["main"]
    paths:
      - "svg/**"
  pull_request:
    branches: ["main"]
    paths:
      - "svg/**"
  workflow_dispatch:
    inputs:
      build_android:
        description: "Build Android"
        required: true
        default: true
        type: boolean
      build_ios:
        description: "Build iOS"
        required: true
        default: true
        type: boolean
      build_harmony:
        description: "Build HarmonyOS"
        required: true
        default: true
        type: boolean

jobs:
  get-version:
    runs-on: lynx-ubuntu-22.04-medium
    timeout-minutes: 60
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v3
      - name: Get Version
        id: get_version
        run: |
          file="svg/ServalSVG.podspec"
          line=$(grep -E "^\s*s\.version\s*=\s*" "$file" | head -n 1)
          version=$(echo "$line" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" | head -n 1)
          if [ -n "$version" ]; then
            echo "VERSION=$version" >> "$GITHUB_OUTPUT"
          else
            echo "Version not found"
            exit 1
          fi

  build-android:
    name: Build Android
    needs: get-version
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_android == true }}
    runs-on: lynx-ubuntu-22.04-large
    steps:
      - uses: actions/checkout@v3
      - name: Setup Java SDK
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: "zulu"
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 9862592

      - name: Install CMake
        run: echo "y" | sdkmanager --install "cmake;3.18.1"

      - name: Build AAR
        working-directory: svg/platform/android
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-aar-${{ needs.get-version.outputs.version }}
          path: svg/platform/android/build/outputs/aar/*.aar

  build-ios:
    name: Build iOS
    needs: get-version
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_ios == true }}
    runs-on: lynx-darwin-14-medium
    steps:
      - uses: actions/checkout@v3

      - name: Install Cocoapods Generate
        run: |
          export SDKROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk
          bundle install --path .bundle

      - name: Generate Workspace
        run: |
          export LANG=en_US.UTF-8
          # Generate an Xcode project/workspace from the podspec to build it
          # We use --local-sources to ensure it uses the checked out code if dependencies allow,
          # but primarily this creates a project for the pod itself.
          bundle exec pod gen svg/ServalSVG.podspec --no-auto-open
          # The workspace is usually generated in ./gen/ServalSVG/

      - name: Build iOS Framework
        run: |
          # Build the generated workspace
          # Adjust the path to the generated workspace if necessary
          xcodebuild build \
            -workspace gen/ServalSVG/ServalSVG.xcworkspace \
            -scheme ServalSVG \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/ios_build \
            CODE_SIGNING_ALLOWED=NO
          tar -cvzf '${{ github.workspace }}/build/ios_build/Build/Products/Release-iphoneos/ServalSVG/ServalSVG.framework.tar.gz' build/ios_build/Build/Products/Release-iphoneos/ServalSVG/ServalSVG.framework
      - name: Upload iOS Artifacts
        uses: lynx-infra/upload-artifact@332ec52e99f7cbf1fbbdc9bcc09280d49147d092
        continue-on-error: true
        with:
          name: ios-framework
          path: build/ios_build/Build/Products/Release-iphoneos/ServalSVG/ServalSVG.framework

      - name: push to release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.get-version.outputs.version }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "${{ github.workspace }}/build/ios_build/Build/Products/Release-iphoneos/ServalSVG/ServalSVG.framework.tar.gz"
          allowUpdates: true
          body: ""
      # - name: Publish to CocoaPods Repo    # 发布 podspec 产物
      #   env:
      #     COCOAPODS_TRUNK_TOKEN: ${{ secrets.REPO_SERVAL_KIT_COCOAPODS_TRUNK_TOKEN }}
      #     POD_VERSION: ${{ needs.get-version.outputs.version }}
      #     PRIMJS_COMMIT_ID: ${{ github.sha }}
      #   run: |-
      #     export LANG=en_US.UTF-8
      #     bundle exec pod repo add-cdn trunk https://cdn.cocoapods.org/
      #     COCOAPODS_TRUNK_TOKEN=$COCOAPODS_TRUNK_TOKEN bundle exec pod trunk push svg/ServalSVG.podspec --skip-import-validation --allow-warnings

  build-harmony:
    name: Build HarmonyOS
    needs: get-version
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_harmony == true }}
    runs-on: lynx-custom-container
    container:
      image: ghcr.io/lynx-family/ubuntu24.04-harmony@sha256:8eb0ee8da7e8592669f0fcd41d0e1bc818b33a75e27943521f57af87d04db2fb
      credentials:
        username: lynx-family
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Download Source
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install dependencies and Build
        shell: bash
        working-directory: .
        run: |
          source tools/envsetup.sh
          pushd svg/platform/harmony && ohpm install && popd
          pushd svg/examples/harmony && ohpm install
          chmod +x ./scripts/build.py
          ./scripts/build.py --modules servalsvg

      - name: Upload Harmony Artifacts
        uses: lynx-infra/upload-artifact@332ec52e99f7cbf1fbbdc9bcc09280d49147d092
        if: success()
        with:
          name: harmony-har
          path: svg/platform/harmony/servalsvg/build/default/outputs/default/servalsvg.har
