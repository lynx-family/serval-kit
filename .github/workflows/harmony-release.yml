name: harmony sdk release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag:
        description: "release tag"
        required: false
        type: string

jobs:
  get-version:
    runs-on: lynx-ubuntu-22.04-medium
    timeout-minutes: 60
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: Get Version
        id: get_version
        run: |-
          if [ ${{ github.event_name }} == 'workflow_dispatch' ]; then
            version=${{ github.event.inputs.tag }}
          else
            version=$(echo ${{ github.ref }} | awk -F "/" '{print $3}')
          fi
          if [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ || \
                $version =~ ^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ || \
                $version =~ ^[0-9]+\.[0-9]+\.[0-9]+-alpha\.[0-9]+$ ]]; then
            echo "Version is valid"
            echo "VERSION=$version" >> $GITHUB_OUTPUT;
          else
            echo "Version is invalid"
            exit 1
          fi

  harmony-release:
    needs: get-version
    runs-on: lynx-custom-container
    container:
      image: ghcr.io/lynx-family/ubuntu24.04-harmony@sha256:8eb0ee8da7e8592669f0fcd41d0e1bc818b33a75e27943521f57af87d04db2fb
      credentials:
        username: lynx-family
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install git-cliff
        run: |
          cargo install git-cliff --locked
          git-cliff --version

      - name: Download Source
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest tag
        id: get-latest-tag
        uses: ./.github/actions/get-latest-tag
        with:
          current-tag: ${{ needs.get-version.outputs.version }}

      - name: Generate Change Log
        shell: bash
        working-directory: .
        run: |
          LATEST_TAG="${{ steps.get-latest-tag.outputs.latest-tag }}"
          COMMIT_RANGE=""
          if [ -n "$LATEST_TAG" ]; then
            COMMIT_ID=$(git rev-list -n 1 "$LATEST_TAG")
            COMMIT_RANGE="$COMMIT_ID..HEAD"
          else
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            COMMIT_RANGE="$FIRST_COMMIT..HEAD"
          fi
          git-cliff --config svg/platform/harmony/servalsvg/cliff.toml \
          $COMMIT_RANGE | sed 's/<!-- version -->/${{ needs.get-version.outputs.version }}/g' > svg/platform/harmony/servalsvg/CHANGELOG.md
          echo "CHANGELOG.md generated successfully"
          cat svg/platform/harmony/servalsvg/CHANGELOG.md

      - name: Install dependencies and Build
        shell: bash
        working-directory: .
        run: |
          source tools/envsetup.sh
          pushd svg/platform/harmony && ohpm install && popd
          pushd svg/examples/harmony && ohpm install
          chmod +x ./scripts/build.py
          ./scripts/build.py --modules servalsvg --publish_har --version ${{ needs.get-version.outputs.version }}
          popd

      - name: Publish Harmony SDK
        shell: bash
        working-directory: .
        run: |
          export PUBLISH_KEY_PASSPHRASE=${{ secrets.HARMONY_PUBLISH_KEY_PASSPHRASE }}
          cat << EOF > publish_key
          ${{ secrets.HARMONY_PUBLISH_KEY }}
          EOF
          PROJECT_ROOT=$(pwd)
          ohpm config set publish_registry https://ohpm.openharmony.cn/ohpm
          pushd svg/platform/harmony/servalsvg/build/default/outputs/default/
          ohpm publish servalsvg.har --publish_id ${{ secrets.HARMONY_PUBLISH_ID }} --key_path $PROJECT_ROOT/publish_key
          popd
